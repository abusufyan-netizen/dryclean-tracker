<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DryClean Tracker (Sheets)</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-box, .app { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; }
        input, button, select { padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        .error { color: red; }
        .order-form { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .order-form input { width: calc(33% - 10px); margin-right: 5px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .status-received { color: orange; font-weight: bold; }
        .status-ready { color: green; font-weight: bold; }
        .status-picked { color: gray; }
        .search-box { margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 10px; }
        .logout { float: right; background: #f44336; }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <!-- Login form -->
        <div id="loginDiv" class="login-box">
            <h2>Employee Login</h2>
            <input type="password" id="passwordInput" placeholder="Password" /><br>
            <button id="loginBtn">Login</button>
            <div id="loginError" class="error"></div>
        </div>

        <!-- Main app (hidden until login) -->
        <div id="appDiv" class="app" style="display: none;">
            <button id="logoutBtn" class="logout">Logout</button>
            <h2>DryClean Order Tracker</h2>

            <!-- Add new order form -->
            <div class="order-form">
                <h3>New Order</h3>
                <input type="text" id="customerName" placeholder="Customer Name" />
                <input type="text" id="items" placeholder="Items (e.g., 2 shirts, 1 coat)" />
                <input type="date" id="receivedDate" />
                <button id="addOrderBtn">Add Order</button>
                <span id="formError" class="error"></span>
            </div>

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by order # or customer name..." />
            </div>

            <!-- Orders table -->
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Received</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                    <!-- populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // CONFIGURATION – REPLACE WITH YOUR APPS SCRIPT URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxj0C7LyWVH_-hur4yf3hOB8jhHCJeZyehHXTINexQzCGN1RVAYUGAIVlhxPPSa7X2d8w/exec'; // e.g., https://script.google.com/macros/s/.../exec

        let currentPassword = ''; // stored after login
        let allOrders = [];

        // DOM elements
        const loginDiv = document.getElementById('loginDiv');
        const appDiv = document.getElementById('appDiv');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');
        const addOrderBtn = document.getElementById('addOrderBtn');
        const customerName = document.getElementById('customerName');
        const items = document.getElementById('items');
        const receivedDate = document.getElementById('receivedDate');
        const formError = document.getElementById('formError');
        const searchInput = document.getElementById('searchInput');
        const ordersBody = document.getElementById('ordersBody');

        // Set today's date as default in the date picker
        const today = new Date().toISOString().split('T')[0];
        receivedDate.value = today;

        // Login
        loginBtn.addEventListener('click', async () => {
            const pwd = passwordInput.value.trim();
            if (!pwd) {
                loginError.textContent = 'Enter password';
                return;
            }
            // Test the password by trying to fetch orders
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getOrders&password=${encodeURIComponent(pwd)}`);
                const data = await response.json();
                if (data.error) {
                    loginError.textContent = 'Invalid password';
                } else {
                    currentPassword = pwd;
                    loginDiv.style.display = 'none';
                    appDiv.style.display = 'block';
                    allOrders = data; // initial load
                    renderOrders(allOrders);
                }
            } catch (err) {
                loginError.textContent = 'Network error – check URL';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            currentPassword = '';
            appDiv.style.display = 'none';
            loginDiv.style.display = 'block';
            passwordInput.value = '';
            loginError.textContent = '';
        });

        // Add new order
        addOrderBtn.addEventListener('click', async () => {
            const name = customerName.value.trim();
            const itemList = items.value.trim();
            const date = receivedDate.value;

            if (!name || !itemList || !date) {
                formError.textContent = 'Please fill all fields';
                return;
            }

            const params = new URLSearchParams({
                action: 'addOrder',
                password: currentPassword,
                customerName: name,
                items: itemList,
                receivedDate: date
            });

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                const result = await response.json();
                if (result.error) {
                    formError.textContent = result.error;
                } else {
                    // Clear form
                    customerName.value = '';
                    items.value = '';
                    receivedDate.value = today;
                    formError.textContent = '';
                    // Refresh orders
                    fetchOrders();
                }
            } catch (err) {
                formError.textContent = 'Network error';
            }
        });

        // Fetch all orders (used after add/update)
        async function fetchOrders() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getOrders&password=${encodeURIComponent(currentPassword)}`);
                const data = await response.json();
                if (!data.error) {
                    allOrders = data;
                    filterAndRenderOrders();
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Search filter
        searchInput.addEventListener('input', filterAndRenderOrders);

        function filterAndRenderOrders() {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = allOrders.filter(order => 
                (order.orderNumber && order.orderNumber.toLowerCase().includes(searchTerm)) ||
                (order.customerName && order.customerName.toLowerCase().includes(searchTerm))
            );
            renderOrders(filtered);
        }

        function renderOrders(orders) {
            ordersBody.innerHTML = '';
            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${order.orderNumber || ''}</td>
                    <td>${order.customerName || ''}</td>
                    <td>${order.items || ''}</td>
                    <td>${order.receivedDate || ''}</td>
                    <td class="status-${order.status || ''}">${order.status || ''}</td>
                    <td>
                        ${order.status === 'received' ? '<button class="markReady" data-order="'+order.orderNumber+'">Mark Ready</button>' : ''}
                        ${order.status === 'ready' ? '<button class="markPicked" data-order="'+order.orderNumber+'">Mark Picked Up</button>' : ''}
                        ${order.status === 'picked' ? '✅ Done' : ''}
                    </td>
                `;
                ordersBody.appendChild(tr);
            });

            // Attach event listeners to buttons
            document.querySelectorAll('.markReady').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const orderNum = e.target.dataset.order;
                    await updateStatus(orderNum, 'ready');
                });
            });
            document.querySelectorAll('.markPicked').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const orderNum = e.target.dataset.order;
                    await updateStatus(orderNum, 'picked');
                });
            });
        }

        async function updateStatus(orderNumber, newStatus) {
            const params = new URLSearchParams({
                action: 'updateStatus',
                password: currentPassword,
                orderNumber: orderNumber,
                status: newStatus
            });

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    fetchOrders(); // refresh
                }
            } catch (err) {
                alert('Network error');
            }
        }
    </script>
</body>
</html>